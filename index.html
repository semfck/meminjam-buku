<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Peminjaman Buku Perpustakaan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-light: #e6e9ff;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        /* [CSS sebelumnya tetap sama...] */

        /* Tambahan style untuk struk */
        .struk-container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            font-family: 'Courier New', monospace;
        }
        
        .struk-header {
            text-align: center;
            border-bottom: 1px dashed #000;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        
        .struk-footer {
            text-align: center;
            border-top: 1px dashed #000;
            padding-top: 10px;
            margin-top: 10px;
            font-size: 0.8rem;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-bold {
            font-weight: bold;
        }
        
        /* Style untuk print */
        @media print {
            body * {
                visibility: hidden;
            }
            .struk-print, .struk-print * {
                visibility: visible;
            }
            .struk-print {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- [Bagian HTML sebelumnya tetap sama...] -->

    <!-- Modal Struk Peminjaman -->
    <div class="modal fade" id="strukPeminjamanModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Struk Peminjaman Buku</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="strukPeminjamanContent" class="struk-container struk-print">
                        <div class="struk-header">
                            <h4>PERPUSTAKAAN DIGITAL</h4>
                            <p>Jl. Perpustakaan No. 123, Kota</p>
                            <p>Telp: (021) 1234567</p>
                            <p>================================</p>
                            <h5>BUKTI PEMINJAMAN BUKU</h5>
                        </div>
                        
                        <div class="struk-body">
                            <table width="100%">
                                <tr>
                                    <td width="30%">No. Transaksi</td>
                                    <td width="5%">:</td>
                                    <td id="strukNoTransaksi">TRX-001</td>
                                </tr>
                                <tr>
                                    <td>Tanggal</td>
                                    <td>:</td>
                                    <td id="strukTanggal">01 Jan 2023</td>
                                </tr>
                                <tr>
                                    <td>Nama Peminjam</td>
                                    <td>:</td>
                                    <td id="strukNamaPeminjam">John Doe</td>
                                </tr>
                                <tr>
                                    <td>No. HP</td>
                                    <td>:</td>
                                    <td id="strukNoHp">08123456789</td>
                                </tr>
                            </table>
                            
                            <p>================================</p>
                            
                            <table width="100%">
                                <thead>
                                    <tr>
                                        <th align="left">Judul Buku</th>
                                        <th align="left">Kode</th>
                                        <th align="left">Kategori</th>
                                    </tr>
                                </thead>
                                <tbody id="strukDetailBuku">
                                    <!-- Data buku akan diisi oleh JavaScript -->
                                </tbody>
                            </table>
                            
                            <p>================================</p>
                            
                            <table width="100%">
                                <tr>
                                    <td>Tanggal Pinjam</td>
                                    <td align="right" id="strukTglPinjam">01 Jan 2023</td>
                                </tr>
                                <tr>
                                    <td>Jatuh Tempo</td>
                                    <td align="right" id="strukJatuhTempo">08 Jan 2023</td>
                                </tr>
                                <tr>
                                    <td>Lama Pinjam</td>
                                    <td align="right" id="strukLamaPinjam">7 hari</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div class="struk-footer">
                            <p>Terima kasih telah meminjam buku di perpustakaan kami</p>
                            <p>Harap kembalikan buku tepat waktu untuk menghindari denda</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer no-print">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary" onclick="printStruk('peminjaman')">
                        <i class="fas fa-print me-2"></i>Cetak Struk
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Struk Pengembalian -->
    <div class="modal fade" id="strukPengembalianModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Struk Pengembalian Buku</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="strukPengembalianContent" class="struk-container struk-print">
                        <div class="struk-header">
                            <h4>PERPUSTAKAAN DIGITAL</h4>
                            <p>Jl. Perpustakaan No. 123, Kota</p>
                            <p>Telp: (021) 1234567</p>
                            <p>================================</p>
                            <h5>BUKTI PENGEMBALIAN BUKU</h5>
                        </div>
                        
                        <div class="struk-body">
                            <table width="100%">
                                <tr>
                                    <td width="30%">No. Transaksi</td>
                                    <td width="5%">:</td>
                                    <td id="strukRetNoTransaksi">TRX-001</td>
                                </tr>
                                <tr>
                                    <td>Tanggal</td>
                                    <td>:</td>
                                    <td id="strukRetTanggal">01 Jan 2023</td>
                                </tr>
                                <tr>
                                    <td>Nama Peminjam</td>
                                    <td>:</td>
                                    <td id="strukRetNamaPeminjam">John Doe</td>
                                </tr>
                                <tr>
                                    <td>No. HP</td>
                                    <td>:</td>
                                    <td id="strukRetNoHp">08123456789</td>
                                </tr>
                            </table>
                            
                            <p>================================</p>
                            
                            <table width="100%">
                                <thead>
                                    <tr>
                                        <th align="left">Judul Buku</th>
                                        <th align="left">Kode</th>
                                        <th align="left">Kategori</th>
                                    </tr>
                                </thead>
                                <tbody id="strukRetDetailBuku">
                                    <!-- Data buku akan diisi oleh JavaScript -->
                                </tbody>
                            </table>
                            
                            <p>================================</p>
                            
                            <table width="100%">
                                <tr>
                                    <td>Tanggal Pinjam</td>
                                    <td align="right" id="strukRetTglPinjam">01 Jan 2023</td>
                                </tr>
                                <tr>
                                    <td>Jatuh Tempo</td>
                                    <td align="right" id="strukRetJatuhTempo">08 Jan 2023</td>
                                </tr>
                                <tr>
                                    <td>Tanggal Kembali</td>
                                    <td align="right" id="strukRetTglKembali">10 Jan 2023</td>
                                </tr>
                                <tr>
                                    <td>Keterlambatan</td>
                                    <td align="right" id="strukRetTelat">2 hari</td>
                                </tr>
                                <tr>
                                    <td class="text-bold">Denda</td>
                                    <td align="right" class="text-bold" id="strukRetDenda">Rp10,000</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div class="struk-footer">
                            <p>Terima kasih telah mengembalikan buku ke perpustakaan kami</p>
                            <p>Silahkan datang kembali untuk meminjam buku lainnya</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer no-print">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary" onclick="printStruk('pengembalian')">
                        <i class="fas fa-print me-2"></i>Cetak Struk
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Manajemen Buku -->
    <div class="modal fade" id="bukuModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Manajemen Data Buku</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formBuku" class="needs-validation" novalidate>
                        <input type="hidden" id="bukuId">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="bukuJudul" class="form-label">Judul Buku</label>
                                <input type="text" class="form-control" id="bukuJudul" required>
                                <div class="invalid-feedback">Harap isi judul buku</div>
                            </div>
                            <div class="col-md-6">
                                <label for="bukuKode" class="form-label">Kode Buku</label>
                                <input type="text" class="form-control" id="bukuKode" required>
                                <div class="invalid-feedback">Harap isi kode buku</div>
                            </div>
                            <div class="col-md-6">
                                <label for="bukuKategori" class="form-label">Kategori</label>
                                <select class="form-select" id="bukuKategori" required>
                                    <option value="">Pilih Kategori</option>
                                    <option value="Fiksi">Fiksi</option>
                                    <option value="Non-Fiksi">Non-Fiksi</option>
                                    <option value="Teknologi">Teknologi</option>
                                    <option value="Sejarah">Sejarah</option>
                                    <option value="Sains">Sains</option>
                                    <option value="Agama">Agama</option>
                                </select>
                                <div class="invalid-feedback">Harap pilih kategori</div>
                            </div>
                            <div class="col-md-6">
                                <label for="bukuStatus" class="form-label">Status</label>
                                <select class="form-select" id="bukuStatus" required>
                                    <option value="Tersedia">Tersedia</option>
                                    <option value="Tidak Tersedia">Tidak Tersedia</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label for="bukuDeskripsi" class="form-label">Deskripsi</label>
                                <textarea class="form-control" id="bukuDeskripsi" rows="3"></textarea>
                            </div>
                        </div>
                    </form>
                    
                    <div class="table-responsive mt-4">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Judul Buku</th>
                                    <th>Kode</th>
                                    <th>Kategori</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="tabelBukuBody">
                                <!-- Data buku akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" id="btnSimpanBuku" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Simpan Buku
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- [Script JS sebelumnya tetap sama...] -->

    <script>
        // ====================== TAMBAHAN INISIALISASI ======================
        const strukPeminjamanModal = new bootstrap.Modal(document.getElementById('strukPeminjamanModal'));
        const strukPengembalianModal = new bootstrap.Modal(document.getElementById('strukPengembalianModal'));
        const bukuModal = new bootstrap.Modal(document.getElementById('bukuModal'));
        
        // ====================== TAMBAHAN FUNGSI BUKU ======================
        async function loadBuku() {
            showLoading('Memuat data buku...');
            
            try {
                const { data, error } = await supabase
                    .from('buku')
                    .select('*')
                    .order('judul', { ascending: true });

                if (error) throw error;

                updateTabelBuku(data || []);
            } catch (error) {
                console.error("Error loading buku:", error);
                showAlert('error', 'Gagal memuat data buku: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        function updateTabelBuku(data) {
            const tbody = document.getElementById('tabelBukuBody');
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-4">
                            <i class="fas fa-book-open fa-2x mb-3 text-muted"></i>
                            <p>Tidak ada data buku</p>
                        </td>
                    </tr>
                `;
                return;
            }

            data.forEach((buku, index) => {
                const row = document.createElement('tr');
                row.className = 'animate__animated animate__fadeIn';
                
                row.innerHTML = `
                    <td>${buku.judul}</td>
                    <td>${buku.kode}</td>
                    <td>${buku.kategori}</td>
                    <td>
                        <span class="badge ${buku.status === 'Tersedia' ? 'bg-success' : 'bg-danger'}">
                            ${buku.status}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editBuku('${buku.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="hapusBuku('${buku.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        async function editBuku(id) {
            showLoading('Memuat data buku...');
            
            try {
                const { data, error } = await supabase
                    .from('buku')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                if (data) {
                    document.getElementById('bukuId').value = data.id;
                    document.getElementById('bukuJudul').value = data.judul;
                    document.getElementById('bukuKode').value = data.kode;
                    document.getElementById('bukuKategori').value = data.kategori;
                    document.getElementById('bukuStatus').value = data.status;
                    document.getElementById('bukuDeskripsi').value = data.deskripsi || '';
                    
                    bukuModal.show();
                }
            } catch (error) {
                console.error("Error loading buku:", error);
                showAlert('error', 'Gagal memuat data buku: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        async function simpanBuku() {
            const form = document.getElementById('formBuku');
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                showAlert('error', 'Harap isi semua field yang wajib dengan data yang valid!');
                return;
            }
            
            showLoading('Menyimpan data buku...');
            
            try {
                const bukuData = {
                    judul: document.getElementById('bukuJudul').value.trim(),
                    kode: document.getElementById('bukuKode').value.trim(),
                    kategori: document.getElementById('bukuKategori').value,
                    status: document.getElementById('bukuStatus').value,
                    deskripsi: document.getElementById('bukuDeskripsi').value.trim() || null
                };

                const bukuId = document.getElementById('bukuId').value;
                let result;

                if (bukuId) {
                    // Update existing book
                    const { data, error } = await supabase
                        .from('buku')
                        .update(bukuData)
                        .eq('id', bukuId)
                        .select();

                    if (error) throw error;
                    result = data;
                } else {
                    // Insert new book
                    const { data, error } = await supabase
                        .from('buku')
                        .insert([bukuData])
                        .select();

                    if (error) throw error;
                    result = data;
                }

                // Reset form
                form.reset();
                form.classList.remove('was-validated');
                document.getElementById('bukuId').value = '';
                
                // Reload books
                await loadBuku();
                
                hideLoading();
                showAlert('success', 'Data buku berhasil disimpan!');
            } catch (error) {
                console.error("Error saving buku:", error);
                hideLoading();
                showAlert('error', 'Gagal menyimpan data buku: ' + error.message);
            }
        }
        
        async function hapusBuku(id) {
            if (!confirm('Apakah Anda yakin ingin menghapus buku ini?')) return;
            
            showLoading('Menghapus data buku...');
            
            try {
                const { error } = await supabase
                    .from('buku')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                
                // Reload books
                await loadBuku();
                
                hideLoading();
                showAlert('success', 'Data buku berhasil dihapus!');
            } catch (error) {
                console.error("Error deleting buku:", error);
                hideLoading();
                showAlert('error', 'Gagal menghapus data buku: ' + error.message);
            }
        }
        
        function openBukuModal() {
            document.getElementById('formBuku').reset();
            document.getElementById('bukuId').value = '';
            bukuModal.show();
        }

        // ====================== TAMBAHAN FUNGSI STRUK ======================
        function generateStrukPeminjaman(peminjaman) {
            document.getElementById('strukNoTransaksi').textContent = `TRX-${peminjaman.id}`;
            document.getElementById('strukTanggal').textContent = formatDate(new Date().toISOString().split('T')[0]);
            document.getElementById('strukNamaPeminjam').textContent = peminjaman.nama;
            document.getElementById('strukNoHp').textContent = peminjaman.no_hp;
            
            const detailBuku = document.getElementById('strukDetailBuku');
            detailBuku.innerHTML = `
                <tr>
                    <td>${peminjaman.judul_buku}</td>
                    <td>${peminjaman.kode_buku}</td>
                    <td>${peminjaman.kategori || '-'}</td>
                </tr>
            `;
            
            document.getElementById('strukTglPinjam').textContent = formatDate(peminjaman.tanggal_pinjam);
            document.getElementById('strukJatuhTempo').textContent = formatDate(peminjaman.tanggal_tempo);
            
            const tglPinjam = new Date(peminjaman.tanggal_pinjam);
            const tglTempo = new Date(peminjaman.tanggal_tempo);
            const diffTime = Math.abs(tglTempo - tglPinjam);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            document.getElementById('strukLamaPinjam').textContent = `${diffDays} hari`;
            
            strukPeminjamanModal.show();
        }
        
        function generateStrukPengembalian(peminjaman) {
            document.getElementById('strukRetNoTransaksi').textContent = `RET-${peminjaman.id}`;
            document.getElementById('strukRetTanggal').textContent = formatDate(new Date().toISOString().split('T')[0]);
            document.getElementById('strukRetNamaPeminjam').textContent = peminjaman.nama;
            document.getElementById('strukRetNoHp').textContent = peminjaman.no_hp;
            
            const detailBuku = document.getElementById('strukRetDetailBuku');
            detailBuku.innerHTML = `
                <tr>
                    <td>${peminjaman.judul_buku}</td>
                    <td>${peminjaman.kode_buku}</td>
                    <td>${peminjaman.kategori || '-'}</td>
                </tr>
            `;
            
            document.getElementById('strukRetTglPinjam').textContent = formatDate(peminjaman.tanggal_pinjam);
            document.getElementById('strukRetJatuhTempo').textContent = formatDate(peminjaman.tanggal_tempo);
            document.getElementById('strukRetTglKembali').textContent = formatDate(peminjaman.tanggal_kembali);
            document.getElementById('strukRetTelat').textContent = peminjaman.hari_telat > 0 ? `${peminjaman.hari_telat} hari` : '-';
            document.getElementById('strukRetDenda').textContent = peminjaman.denda > 0 ? formatCurrency(peminjaman.denda) : '-';
            
            strukPengembalianModal.show();
        }
        
        function printStruk(type) {
            const printContent = type === 'peminjaman' 
                ? document.getElementById('strukPeminjamanContent')
                : document.getElementById('strukPengembalianContent');
                
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Struk ${type === 'peminjaman' ? 'Peminjaman' : 'Pengembalian'}</title>
                        <style>
                            body { font-family: Arial, sans-serif; }
                            .struk-container { width: 100%; max-width: 400px; margin: 0 auto; }
                            .struk-header { text-align: center; border-bottom: 1px dashed #000; padding-bottom: 10px; margin-bottom: 10px; }
                            .struk-footer { text-align: center; border-top: 1px dashed #000; padding-top: 10px; margin-top: 10px; font-size: 0.8rem; }
                            .text-right { text-align: right; }
                            .text-center { text-align: center; }
                            .text-bold { font-weight: bold; }
                            table { width: 100%; }
                        </style>
                    </head>
                    <body onload="window.print(); window.close();">
                        ${printContent.innerHTML}
                    </body>
                </html>
            `);
            printWindow.document.close();
        }

        // ====================== MODIFIKASI FUNGSI PEMINJAMAN ======================
        async function simpanPeminjaman() {
            const form = document.getElementById('formPeminjaman');
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                showAlert('error', 'Harap isi semua field yang wajib dengan data yang valid!');
                return;
            }
            
            showLoading('Menyimpan data peminjaman...');
            
            try {
                // Cek ketersediaan buku
                const kodeBuku = document.getElementById('kodeBuku').value.trim();
                const { data: bukuData, error: bukuError } = await supabase
                    .from('buku')
                    .select('*')
                    .eq('kode', kodeBuku)
                    .single();

                if (bukuError || !bukuData) throw new Error('Buku tidak ditemukan');
                if (bukuData.status !== 'Tersedia') throw new Error('Buku tidak tersedia untuk dipinjam');

                const peminjamanData = {
                    nama: document.getElementById('namaPeminjam').value.trim(),
                    no_hp: document.getElementById('noHp').value.trim(),
                    email: document.getElementById('email').value.trim() || null,
                    judul_buku: bukuData.judul,
                    kode_buku: bukuData.kode,
                    kategori: bukuData.kategori,
                    tanggal_pinjam: document.getElementById('tanggalPinjam').value,
                    tanggal_tempo: hitungJatuhTempo(),
                    status: 'Dipinjam'
                };

                const { data, error } = await supabase
                    .from('peminjaman')
                    .insert([peminjamanData])
                    .select();

                if (error) throw error;

                // Update status buku menjadi tidak tersedia
                await supabase
                    .from('buku')
                    .update({ status: 'Tidak Tersedia' })
                    .eq('id', bukuData.id);

                // Reset form
                form.reset();
                form.classList.remove('was-validated');
                document.getElementById('tanggalPinjam').value = new Date().toISOString().split('T')[0];
                document.getElementById('jatuhTempo').value = '';
                
                hideLoading();
                showAlert('success', 'Peminjaman berhasil disimpan!');
                
                // Tampilkan struk peminjaman
                generateStrukPeminjaman(data[0]);
                
                // Navigate to returns tab and refresh data
                document.getElementById('pengembalian-tab').click();
                await loadPeminjaman();
            } catch (error) {
                console.error("Error saving peminjaman:", error);
                hideLoading();
                showAlert('error', 'Gagal menyimpan data peminjaman: ' + error.message);
            }
        }

        // ====================== MODIFIKASI FUNGSI PENGEMBALIAN ======================
        async function prosesPengembalian() {
            showLoading('Memproses pengembalian...');
            
            try {
                const id = document.getElementById('pengembalianModal').getAttribute('data-id');
                const tanggalKembali = document.getElementById('modalTanggalKembali').value;
                
                if (!tanggalKembali) {
                    throw new Error('Harap isi tanggal kembali');
                }
                
                // Hitung denda
                const peminjaman = peminjamanList.find(p => p.id === id);
                const tglTempo = new Date(peminjaman.tanggal_tempo);
                const tglKembali = new Date(tanggalKembali);
                const hariTelat = Math.max(0, Math.floor((tglKembali - tglTempo) / (1000 * 60 * 60 * 24)));
                const denda = hariTelat * DENDA_PER_HARI;
                
                // Update data peminjaman
                const { data, error } = await supabase
                    .from('peminjaman')
                    .update({
                        tanggal_kembali: tanggalKembali,
                        hari_telat: hariTelat,
                        denda: denda,
                        status: denda > 0 ? 'Dikembalikan (Denda)' : 'Dikembalikan'
                    })
                    .eq('id', id)
                    .select();

                if (error) throw error;
                
                // Update status buku menjadi tersedia
                await supabase
                    .from('buku')
                    .update({ status: 'Tersedia' })
                    .eq('kode', peminjaman.kode_buku);

                hideLoading();
                showAlert('success', 'Pengembalian berhasil diproses!');
                
                // Tampilkan struk pengembalian
                generateStrukPengembalian(data[0]);
                
                // Tutup modal dan refresh data
                pengembalianModal.hide();
                await loadPeminjaman();
                await loadRiwayat();
            } catch (error) {
                console.error("Error processing pengembalian:", error);
                hideLoading();
                showAlert('error', 'Gagal memproses pengembalian: ' + error.message);
            }
        }

        // ====================== MODIFIKASI INITIALIZATION ======================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Set default dates
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('tanggalPinjam').value = today;
                document.getElementById('modalTanggalKembali').value = today;
                document.getElementById('filterDari').value = getFirstDayOfMonth();
                document.getElementById('filterSampai').value = today;
                
                // Event listeners for due date calculation
                document.getElementById('lamaPinjam').addEventListener('change', hitungJatuhTempo);
                document.getElementById('tanggalPinjam').addEventListener('change', hitungJatuhTempo);
                
                // Setup other event listeners
                setupEventListeners();
                
                // Load initial data
                await Promise.all([
                    loadPeminjaman(),
                    loadRiwayat(),
                    loadBuku()
                ]);
                
                // Show welcome message
                showAlert('info', 'Selamat datang di Sistem Peminjaman Buku Perpustakaan');
            } catch (error) {
                console.error("Initialization error:", error);
                showAlert('error', 'Gagal memuat aplikasi: ' + error.message);
            }
        });

        // ====================== TAMBAHAN EVENT LISTENER ======================
        function setupEventListeners() {
            // [Event listener sebelumnya tetap sama...]
            
            // Buku functions
            document.getElementById('btnSimpanBuku').addEventListener('click', simpanBuku);
            
            // Tombol manajemen buku di navbar
            document.getElementById('btnManajemenBuku').addEventListener('click', openBukuModal);
        }
    </script>
</body>
</html>