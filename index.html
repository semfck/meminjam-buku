<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com 'nonce-randomNonceValue';
        style-src 'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com 'unsafe-inline';
        font-src 'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com;
        img-src 'self' data:;
    ">
    <title>Sistem Peminjaman Buku Perpustakaan</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-light: #e6e9ff;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color);
        }

        .card {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: #3a56d4;
            border-color: #3a56d4;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .badge-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .badge-success {
            background-color: var(--success-color);
            color: white;
        }

        .badge-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .table-responsive {
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        table {
            margin-bottom: 0;
        }

        thead {
            background-color: var(--primary-light);
        }

        th {
            font-weight: 600;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
        }

        /* Validation styles */
        .form-control:invalid, .form-select:invalid {
            border-color: var(--danger-color);
        }

        .form-control:invalid:focus, .form-select:invalid:focus {
            box-shadow: 0 0 0 0.25rem rgba(231, 76, 60, 0.25);
        }

        .invalid-feedback {
            color: var(--danger-color);
            font-size: 0.85rem;
            display: none;
        }

        .was-validated .form-control:invalid ~ .invalid-feedback,
        .was-validated .form-select:invalid ~ .invalid-feedback {
            display: block;
        }

        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: var(--primary-color);
        }

        #alertContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
            max-width: 400px;
        }

        .alert {
            box-shadow: var(--box-shadow);
        }

        .nav-tabs .nav-link {
            color: var(--secondary-color);
            font-weight: 500;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            font-weight: 600;
            border-bottom: 2px solid var(--primary-color);
        }

        .pagination .page-item.active .page-link {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .pagination .page-link {
            color: var(--primary-color);
        }

        /* Book status colors */
        .status-borrowed {
            background-color: var(--warning-color);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .status-late {
            background-color: var(--danger-color);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .status-returned {
            background-color: var(--success-color);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .status-available {
            background-color: var(--success-color);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        /* Action buttons */
        .action-buttons button {
            padding: 5px 10px;
            margin-right: 5px;
            font-size: 14px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
        }

        .delete-btn {
            background-color: var(--danger-color);
            color: white;
        }

        .delete-btn:hover {
            background-color: #c82333;
        }

        .edit-btn {
            background-color: var(--warning-color);
            color: #212529;
        }

        .edit-btn:hover {
            background-color: #e0a800;
        }

        /* Invoice Specific Styles */
        #invoiceModal .modal-content {
            border-radius: 10px;
            overflow: hidden;
        }

        #invoiceModal .modal-header {
            border-bottom: 2px solid rgba(255,255,255,0.2);
        }

        #invoiceModal .table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        #invoiceModal .table-bordered {
            border: 1px solid #dee2e6;
        }

        #invoiceModal .table-bordered th,
        #invoiceModal .table-bordered td {
            border: 1px solid #dee2e6;
            padding: 8px 12px;
        }

        #invoiceModal .signature-box {
            height: 100px;
            margin-top: 50px;
            position: relative;
        }

        #invoiceModal .signature-line {
            position: absolute;
            bottom: 0;
            width: 100%;
            border-top: 1px solid #000;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .app-container {
                padding: 10px;
            }
            
            .card {
                margin-bottom: 15px;
            }
            
            #alertContainer {
                max-width: 90%;
                left: 5%;
                right: 5%;
                top: 10px;
            }
            
            .action-buttons button {
                margin-bottom: 5px;
                width: 100%;
            }

            #invoiceModal .modal-dialog {
                margin: 10px;
            }
            
            #invoiceModal .text-md-end {
                text-align: left !important;
            }
            
            #invoiceModal .modal-body {
                padding: 15px;
            }
        }

        @media print {
            body * {
                visibility: hidden;
            }
            #invoiceModal .modal-content,
            #invoiceModal .modal-content * {
                visibility: visible;
            }
            #invoiceModal .modal-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                border: none;
                box-shadow: none;
            }
            .no-print {
                display: none !important;
            }
            #invoiceModal .modal-header {
                background-color: #4361ee !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            #invoiceModal .table-light th {
                background-color: #f8f9fa !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div id="loadingText" class="mt-3">Memproses...</div>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer"></div>

    <div class="app-container">
        <!-- Header -->
        <nav class="navbar navbar-expand-lg navbar-light bg-white mb-4 rounded shadow-sm">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-book-open me-2"></i>
                    Sistem Peminjaman Buku
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link active" href="#peminjaman-tab" data-bs-toggle="tab">
                                <i class="fas fa-book-reader me-1"></i> Peminjaman
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#pengembalian-tab" data-bs-toggle="tab">
                                <i class="fas fa-undo me-1"></i> Pengembalian
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#riwayat-tab" data-bs-toggle="tab">
                                <i class="fas fa-history me-1"></i> Riwayat
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="tab-content">
            <!-- Peminjaman Tab -->
            <div class="tab-pane fade show active" id="peminjaman-tab">
                <!-- Form Peminjaman -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-plus-circle me-2"></i>Form Peminjaman Buku
                    </div>
                    <div class="card-body">
                        <form id="formPeminjaman" class="needs-validation" novalidate>
                            <input type="hidden" id="bookId">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="judulBuku" class="form-label">Judul Buku</label>
                                    <input type="text" class="form-control" id="judulBuku" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label for="pengarang" class="form-label">Pengarang</label>
                                    <input type="text" class="form-control" id="pengarang" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label for="tahunTerbit" class="form-label">Tahun Terbit</label>
                                    <input type="number" class="form-control" id="tahunTerbit" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label for="isbn" class="form-label">ISBN</label>
                                    <input type="text" class="form-control" id="isbn" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label for="kategori" class="form-label">Kategori</label>
                                    <input type="text" class="form-control" id="kategori" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label for="namaPeminjam" class="form-label">Nama Peminjam</label>
                                    <input type="text" class="form-control" id="namaPeminjam" 
                                           required minlength="3" maxlength="50" 
                                           pattern="[A-Za-z ]+">
                                    <div class="invalid-feedback">Nama hanya boleh mengandung huruf dan spasi (3-50 karakter)</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="noHp" class="form-label">No. HP</label>
                                    <input type="tel" class="form-control" id="noHp" 
                                           required pattern="08[0-9]{8,11}">
                                    <div class="invalid-feedback">Format nomor HP tidak valid (contoh: 081234567890)</div>
                                </div>
                                <div class="col-md-4">
                                    <label for="tanggalPinjam" class="form-label">Tanggal Pinjam</label>
                                    <input type="date" class="form-control" id="tanggalPinjam" required>
                                    <div class="invalid-feedback">Harap pilih tanggal pinjam</div>
                                </div>
                                <div class="col-md-4">
                                    <label for="lamaPinjam" class="form-label">Lama Pinjam (minggu)</label>
                                    <select class="form-select" id="lamaPinjam" required>
                                        <option value="">Pilih lama pinjam</option>
                                        <option value="1">1 Minggu</option>
                                        <option value="2">2 Minggu</option>
                                        <option value="3">3 Minggu</option>
                                        <option value="4">4 Minggu</option>
                                    </select>
                                    <div class="invalid-feedback">Harap pilih lama pinjam</div>
                                </div>
                                <div class="col-md-4">
                                    <label for="jatuhTempo" class="form-label">Jatuh Tempo</label>
                                    <input type="text" class="form-control" id="jatuhTempo" readonly>
                                </div>
                                <div class="col-12">
                                    <label for="catatan" class="form-label">Catatan</label>
                                    <textarea class="form-control" id="catatan" rows="3" maxlength="200"></textarea>
                                    <small class="text-muted"><span id="charCount">0</span>/200 karakter</small>
                                </div>
                            </div>
                            <div class="mt-4">
                                <button type="submit" id="btnSimpan" class="btn btn-primary px-4">
                                    <i class="fas fa-save me-2"></i>Simpan Peminjaman
                                </button>
                                <button type="button" id="btnReset" class="btn btn-secondary px-4 ms-2">
                                    <i class="fas fa-undo me-2"></i>Reset Form
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Daftar Buku Tersedia -->
                <div class="card mt-4">
                    <div class="card-header">
                        <i class="fas fa-book me-2"></i>Daftar Buku Tersedia
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs mb-4" id="bookCategoryTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="fiksi-tab" data-bs-toggle="tab" data-bs-target="#fiksi" type="button" role="tab">
                                    <i class="fas fa-book-open me-1"></i>Fiksi
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="nonfiksi-tab" data-bs-toggle="tab" data-bs-target="#nonfiksi" type="button" role="tab">
                                    <i class="fas fa-scroll me-1"></i>Non-Fiksi
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="teknologi-tab" data-bs-toggle="tab" data-bs-target="#teknologi" type="button" role="tab">
                                    <i class="fas fa-laptop-code me-1"></i>Teknologi
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="sejarah-tab" data-bs-toggle="tab" data-bs-target="#sejarah" type="button" role="tab">
                                    <i class="fas fa-landmark me-1"></i>Sejarah
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="bookCategoryContent">
                            <!-- Tab Fiksi -->
                            <div class="tab-pane fade show active" id="fiksi" role="tabpanel">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th width="30%">Judul</th>
                                                <th width="25%">Pengarang</th>
                                                <th width="15%">Tahun</th>
                                                <th width="15%">ISBN</th>
                                                <th width="15%">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Laskar Pelangi</td>
                                                <td>Andrea Hirata</td>
                                                <td>2005</td>
                                                <td>979-3062-79-7</td>
                                                <td><button class="btn btn-primary btn-sm" onclick="selectBookFromTable('Laskar Pelangi', 'Andrea Hirata', '2005', 'Fiksi', '979-3062-79-7')">
                                                    <i class="fas fa-hand-holding me-1"></i>Pinjam
                                                </button></td>
                                            </tr>
                                            <tr>
                                                <td>Bumi Manusia</td>
                                                <td>Pramoedya Ananta Toer</td>
                                                <td>1980</td>
                                                <td>979-8659-17-6</td>
                                                <td><button class="btn btn-primary btn-sm" onclick="selectBookFromTable('Bumi Manusia', 'Pramoedya Ananta Toer', '1980', 'Fiksi', '979-8659-17-6')">
                                                    <i class="fas fa-hand-holding me-1"></i>Pinjam
                                                </button></td>
                                            </tr>
                                            <tr>
                                                <td>Perahu Kertas</td>
                                                <td>Dee Lestari</td>
                                                <td>2009</td>
                                                <td>978-979-22-3845-3</td>
                                                <td><button class="btn btn-primary btn-sm" onclick="selectBookFromTable('Perahu Kertas', 'Dee Lestari', '2009', 'Fiksi', '978-979-22-3845-3')">
                                                    <i class="fas fa-hand-holding me-1"></i>Pinjam
                                                </button></td>
                                            </tr>
                                            <tr>
                                                <td>Pulang</td>
                                                <td>Tere Liye</td>
                                                <td>2015</td>
                                                <td>978-602-03-1128-5</td>
                                                <td><button class="btn btn-primary btn-sm" onclick="selectBookFromTable('Pulang', 'Tere Liye', '2015', 'Fiksi', '978-602-03-1128-5')">
                                                    <i class="fas fa-hand-holding me-1"></i>Pinjam
                                                </button></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Tab Non-Fiksi -->
                            <div class="tab-pane fade" id="nonfiksi" role="tabpanel">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th width="30%">Judul</th>
                                                <th width="25%">Pengarang</th>
                                                <th width="15%">Tahun</th>
                                                <th width="15%">ISBN</th>
                                                <th width="15%">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Filosofi Teras</td>
                                                <td>Henry Manampiring</td>
                                                <td>2018</td>
                                                <td>978-602-424-698-5</td>
                                                <td><button class="btn btn-primary btn-sm" onclick="selectBookFromTable('Filosofi Teras', 'Henry Manampiring', '2018', 'Non-Fiksi', '978-602-424-698-5')">
                                                    <i class="fas fa-hand-holding me-1"></i>Pinjam
                                                </button></td>
                                            </tr>
                                            <tr>
                                                <td>Atomic Habits</td>
                                                <td>James Clear</td>
                                                <td>2018</td>
                                                <td>978-1847941831</td>
                                                <td><button class="btn btn-primary btn-sm" onclick="selectBookFromTable('Atomic Habits', 'James Clear', '2018', 'Non-Fiksi', '978-1847941831')">
                                                    <i class="fas fa-hand-holding me-1"></i>Pinjam
                                                </button></td>
                                            </tr>
                                            <tr>
                                                <td>Sebuah Seni untuk Bersikap Bodo Amat</td>
                                                <td>Mark Manson</td>
                                                <td>2016</td>
                                                <td>978-0062457714</td>
                                                <td><button class="btn btn-primary btn-sm" onclick="selectBookFromTable('Sebuah Seni untuk Bersikap Bodo Amat', 'Mark Manson', '2016', 'Non-Fiksi', '978-0062457714')">
                                                    <i class="fas fa-hand-holding me-1"></i>Pinjam
                                                </button></td>
                                            </tr>
                                            <tr>
                                                <td>Rich Dad Poor Dad</td>
                                                <td>Robert Kiyosaki</td>
                                                <td>1997</td>
                                                <td>978-1612680194</td>
                                                <td><button class="btn btn-primary btn-sm" onclick="selectBookFromTable('Rich Dad Poor Dad', 'Robert Kiyosaki', '1997', 'Non-Fiksi', '978-1612680194')">
                                                    <i class="fas fa-hand-holding me-1"></i>Pinjam
                                                </button></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Tab Teknologi -->
                            <div class="tab-pane fade" id="teknologi" role="tabpanel">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th width="30%">Judul</th>
                                                <th width="25%">Pengarang</th>
                                                <th width="15%">Tahun</th>
                                                <th width="15%">ISBN</th>
                                                <th width="15%">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Clean Code</td>
                                                <td>Robert C. Martin</td>
                                                <td>2008</td>
                                                <td>978-0132350884</td>
                                                <td><button class="btn btn-primary btn-sm" onclick="selectBookFromTable('Clean Code', 'Robert C. Martin', '2008', 'Teknologi', '978-0132350884')">
                                                    <i class="fas fa-hand-holding me-1"></i>Pinjam
                                                </button></td>
                                            </tr>
                                            <tr>
                                                <td>The Pragmatic Programmer</td>
                                                <td>Andrew Hunt, David Thomas</td>
                                                <td>1999</td>
                                                <td>978-0201616224</td>
                                                <td><button class="btn btn-primary btn-sm" onclick="selectBookFromTable('The Pragmatic Programmer', 'Andrew Hunt, David Thomas', '1999', 'Teknologi', '978-0201616224')">
                                                    <i class="fas fa-hand-holding me-1"></i>Pinjam
                                                </button></td>
                                            </tr>
                                            <tr>
                                                <td>Designing Data-Intensive Applications</td>
                                                <td>Martin Kleppmann</td>
                                                <td>2017</td>
                                                <td>978-1449373320</td>
                                                <td><button class="btn btn-primary btn-sm" onclick="selectBookFromTable('Designing Data-Intensive Applications', 'Martin Kleppmann', '2017', 'Teknologi', '978-1449373320')">
                                                    <i class="fas fa-hand-holding me-1"></i>Pinjam
                                                </button></td>
                                            </tr>
                                            <tr>
                                                <td>Artificial Intelligence: A Modern Approach</td>
                                                <td>Stuart Russell, Peter Norvig</td>
                                                <td>1995</td>
                                                <td>978-0136042594</td>
                                                <td><button class="btn btn-primary btn-sm" onclick="selectBookFromTable('Artificial Intelligence: A Modern Approach', 'Stuart Russell, Peter Norvig', '1995', 'Teknologi', '978-0136042594')">
                                                    <i class="fas fa-hand-holding me-1"></i>Pinjam
                                                </button></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Tab Sejarah -->
                            <div class="tab-pane fade" id="sejarah" role="tabpanel">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th width="30%">Judul</th>
                                                <th width="25%">Pengarang</th>
                                                <th width="15%">Tahun</th>
                                                <th width="15%">ISBN</th>
                                                <th width="15%">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Sejarah Dunia yang Disembunyikan</td>
                                                <td>Jonathan Black</td>
                                                <td>2013</td>
                                                <td>978-602-03-1128-5</td>
                                                <td><button class="btn btn-primary btn-sm" onclick="selectBookFromTable('Sejarah Dunia yang Disembunyikan', 'Jonathan Black', '2013', 'Sejarah', '978-602-03-1128-5')">
                                                    <i class="fas fa-hand-holding me-1"></i>Pinjam
                                                </button></td>
                                            </tr>
                                            <tr>
                                                <td>Sejarah Indonesia Modern</td>
                                                <td>M.C. Ricklefs</td>
                                                <td>1981</td>
                                                <td>978-979-421-857-0</td>
                                                <td><button class="btn btn-primary btn-sm" onclick="selectBookFromTable('Sejarah Indonesia Modern', 'M.C. Ricklefs', '1981', 'Sejarah', '978-979-421-857-0')">
                                                    <i class="fas fa-hand-holding me-1"></i>Pinjam
                                                </button></td>
                                            </tr>
                                            <tr>
                                                <td>Sejarah Eropa</td>
                                                <td>Norman Davies</td>
                                                <td>1996</td>
                                                <td>978-019-820171-7</td>
                                                <td><button class="btn btn-primary btn-sm" onclick="selectBookFromTable('Sejarah Eropa', 'Norman Davies', '1996', 'Sejarah', '978-019-820171-7')">
                                                    <i class="fas fa-hand-holding me-1"></i>Pinjam
                                                </button></td>
                                            </tr>
                                            <tr>
                                                <td>Sejarah Peradaban Islam</td>
                                                <td>Badri Yatim</td>
                                                <td>1993</td>
                                                <td>978-979-421-290-5</td>
                                                <td><button class="btn btn-primary btn-sm" onclick="selectBookFromTable('Sejarah Peradaban Islam', 'Badri Yatim', '1993', 'Sejarah', '978-979-421-290-5')">
                                                    <i class="fas fa-hand-holding me-1"></i>Pinjam
                                                </button></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pengembalian Tab -->
            <div class="tab-pane fade" id="pengembalian-tab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-undo me-2"></i>Daftar Peminjaman Aktif</span>
                        <div>
                            <input type="search" id="searchPeminjaman" class="form-control form-control-sm" placeholder="Cari...">
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th width="5%">No</th>
                                        <th>Judul Buku</th>
                                        <th>Pengarang</th>
                                        <th>Nama Peminjam</th>
                                        <th>Tanggal Pinjam</th>
                                        <th>Jatuh Tempo</th>
                                        <th>Status</th>
                                        <th width="15%">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="pengembalianBody">
                                    <!-- Data akan diisi oleh JavaScript -->
                                    <tr>
                                        <td colspan="8" class="text-center py-4">
                                            <i class="fas fa-book-open fa-2x mb-3 text-muted"></i>
                                            <p>Memuat data peminjaman...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Riwayat Tab -->
            <div class="tab-pane fade" id="riwayat-tab">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-history me-2"></i>Riwayat Peminjaman
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="filterDari" class="form-label">Dari Tanggal</label>
                                <input type="date" class="form-control" id="filterDari">
                            </div>
                            <div class="col-md-3">
                                <label for="filterSampai" class="form-label">Sampai Tanggal</label>
                                <input type="date" class="form-control" id="filterSampai">
                            </div>
                            <div class="col-md-4">
                                <label for="searchRiwayat" class="form-label">Pencarian</label>
                                <input type="search" class="form-control" id="searchRiwayat" placeholder="Cari nama, judul buku, atau kode...">
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button id="btnFilter" class="btn btn-primary w-100">
                                    <i class="fas fa-filter me-1"></i> Filter
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th width="5%">No</th>
                                        <th>Judul Buku</th>
                                        <th>Pengarang</th>
                                        <th>Nama Peminjam</th>
                                        <th>Tanggal Pinjam</th>
                                        <th>Jatuh Tempo</th>
                                        <th>Tanggal Kembali</th>
                                        <th>Keterlambatan</th>
                                        <th>Denda</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="riwayatBody">
                                    <!-- Data akan diisi oleh JavaScript -->
                                    <tr>
                                        <td colspan="10" class="text-center py-4">
                                            <i class="fas fa-book-open fa-2x mb-3 text-muted"></i>
                                            <p>Memuat data riwayat...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div>
                                <span id="totalData">0</span> data ditemukan | 
                                Total Denda: <span id="totalDenda">Rp0</span>
                            </div>
                            <div class="d-flex">
                                <button id="btnPrev" class="btn btn-outline-primary btn-sm me-2" disabled>
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button id="btnNext" class="btn btn-outline-primary btn-sm" disabled>
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Pengembalian -->
    <div class="modal fade" id="pengembalianModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Proses Pengembalian Buku</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="modalJudulBuku" class="form-label">Judul Buku</label>
                        <input type="text" class="form-control" id="modalJudulBuku" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="modalPengarang" class="form-label">Pengarang</label>
                        <input type="text" class="form-control" id="modalPengarang" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="modalNamaPeminjam" class="form-label">Nama Peminjam</label>
                        <input type="text" class="form-control" id="modalNamaPeminjam" readonly>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="modalTanggalPinjam" class="form-label">Tanggal Pinjam</label>
                            <input type="text" class="form-control" id="modalTanggalPinjam" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="modalJatuhTempo" class="form-label">Jatuh Tempo</label>
                            <input type="text" class="form-control" id="modalJatuhTempo" readonly>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="modalTanggalKembali" class="form-label">Tanggal Kembali</label>
                        <input type="date" class="form-control" id="modalTanggalKembali" required>
                        <div class="invalid-feedback">Harap pilih tanggal kembali</div>
                    </div>
                    <div class="mb-3">
                        <label for="modalHariTelat" class="form-label">Keterlambatan</label>
                        <input type="text" class="form-control" id="modalHariTelat" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="modalDenda" class="form-label">Denda</label>
                        <input type="text" class="form-control" id="modalDenda" readonly>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" id="btnProsesPengembalian" class="btn btn-primary">Proses Pengembalian</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Detail Buku -->
    <div class="modal fade" id="bookDetailModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detail Buku</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <table class="table">
                        <tr><th>Judul</th><td id="detailJudul">-</td></tr>
                        <tr><th>Pengarang</th><td id="detailPengarang">-</td></tr>
                        <tr><th>Tahun</th><td id="detailTahun">-</td></tr>
                        <tr><th>Kategori</th><td id="detailKategori">-</td></tr>
                        <tr><th>ISBN</th><td id="detailISBN">-</td></tr>
                        <tr><th>Deskripsi</th><td id="detailDeskripsi">-</td></tr>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary" id="btnBorrowFromDetail">
                        <i class="fas fa-hand-holding me-1"></i>Pinjam Buku Ini
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Konfirmasi Pembayaran -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Konfirmasi Pembayaran Denda</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Apakah Anda yakin ingin menandai denda ini sebagai sudah dibayar?</p>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Pastikan pembayaran telah diterima sebelum mengkonfirmasi.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" id="btnConfirmPayment" class="btn btn-success">Konfirmasi Pembayaran</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Invoice -->
    <div class="modal fade" id="invoiceModal" tabindex="-1" aria-labelledby="invoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="invoiceModalLabel">INVOICE PEMINJAMAN BUKU</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <h4 class="mb-1">PERPUSTAKAAN ONLINE</h4>
                        <p class="mb-1 text-muted">Jl. Contoh No. 123, Kota Anda</p>
                        <p class="mb-0 text-muted">Telp: 08123456789 | Email: perpustakaan@example.com</p>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>Informasi Peminjam:</h5>
                            <p class="mb-1"><strong>Nama:</strong> <span id="invoiceNamaPeminjam">-</span></p>
                            <p class="mb-1"><strong>No. HP:</strong> <span id="invoiceNoHp">-</span></p>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <p class="mb-1"><strong>No. Invoice:</strong> <span id="invoiceNumber">-</span></p>
                            <p class="mb-1"><strong>Tanggal Pinjam:</strong> <span id="invoiceTanggalPinjam">-</span></p>
                            <p class="mb-1"><strong>Jatuh Tempo:</strong> <span id="invoiceJatuhTempo">-</span></p>
                        </div>
                    </div>
                    
                    <div class="table-responsive mb-4">
                        <table class="table table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th width="40%">Judul Buku</th>
                                    <th width="30%">Pengarang</th>
                                    <th width="15%">Lama Pinjam</th>
                                    <th width="15%">Status</th>
                                </tr>
                            </thead>
                            <tbody id="invoiceBookDetails">
                                <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Denda Section (hidden by default) -->
                    <div id="dendaSection" class="d-none">
                        <h5 class="mb-3">Rincian Denda Keterlambatan:</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Tanggal Kembali:</strong> <span id="invoiceTanggalKembali">-</span></p>
                                <p class="mb-1"><strong>Keterlambatan:</strong> <span id="invoiceHariTelat">0</span> hari</p>
                            </div>
                            <div class="col-md-6 text-md-end">
                                <p class="mb-1"><strong>Denda per Hari:</strong> Rp5,000</p>
                                <p class="mb-1"><strong>Total Denda:</strong> <span id="invoiceDenda">Rp0</span></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4 no-print">
                        <div class="col-md-6">
                            <div class="border p-3 text-center">
                                <h5>Petugas Perpustakaan</h5>
                                <div class="signature-box">
                                    <div class="signature-line"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border p-3 text-center">
                                <h5>Peminjam</h5>
                                <div class="signature-box">
                                    <div class="signature-line"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer no-print">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" id="btnCetakInvoice" class="btn btn-primary">
                        <i class="fas fa-print me-2"></i>Cetak Invoice
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase JS -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js" nonce="randomNonceValue"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js" nonce="randomNonceValue"></script>

    <!-- Other dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" nonce="randomNonceValue"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2" nonce="randomNonceValue"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js" nonce="randomNonceValue"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" nonce="randomNonceValue"></script>
    
    <script nonce="randomNonceValue">
        // ====================== GLOBAL CONSTANTS ======================
        const DENDA_PER_HARI = 5000;
        const ITEMS_PER_PAGE = 10;
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCCi8CdLNb1O6uEZBpVoeH_3mJhXElBGTU",
            authDomain: "meminjam-buku.firebaseapp.com",
            projectId: "meminjam-buku",
            storageBucket: "meminjam-buku.firebasestorage.app",
            messagingSenderId: "517105835463",
            appId: "1:517105835463:web:90dcc1dfa5d2ffc6e38de2",
            measurementId: "G-KK3XQDMD9G"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', async function() {
            // ====================== GLOBAL VARIABLES ======================
            let bukuList = [];
            let peminjamanList = [];
            let riwayatList = [];
            let currentInvoice = null;
            let currentPage = 1;
            let reportChart = null;
    
            // Initialize Bootstrap components
            let pengembalianModal = new bootstrap.Modal(document.getElementById('pengembalianModal'));
            let confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
            let invoiceModal = new bootstrap.Modal(document.getElementById('invoiceModal'));
            
            // Set today as default date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggalPinjam').value = today;
            document.getElementById('modalTanggalKembali').value = today;
            
            // Set first day of month as default filter
            document.getElementById('filterDari').value = getFirstDayOfMonth();
            document.getElementById('filterSampai').value = today;
            
            // Setup event listeners
            setupEventListeners();
        });

        function setupEventListeners() {
            // Peminjaman form
            document.getElementById('formPeminjaman').addEventListener('submit', function(e) {
                e.preventDefault();
                simpanPeminjaman();
            });
            
            document.getElementById('btnReset').addEventListener('click', resetForm);
            
            // Date calculations
            document.getElementById('tanggalPinjam').addEventListener('change', hitungJatuhTempo);
            document.getElementById('lamaPinjam').addEventListener('change', hitungJatuhTempo);
            
            // Character counter
            document.getElementById('catatan').addEventListener('input', function() {
                document.getElementById('charCount').textContent = this.value.length + '/200';
            });
            
            // Pengembalian
            document.getElementById('modalTanggalKembali').addEventListener('change', function() {
                validateReturnDate();
                previewDenda();
            });
            
            document.getElementById('btnProsesPengembalian').addEventListener('click', prosesPengembalian);
            
            // Riwayat
            document.getElementById('searchPeminjaman').addEventListener('input', debounce(searchPeminjaman, 300));
            document.getElementById('searchRiwayat').addEventListener('input', debounce(searchRiwayat, 300));
            document.getElementById('btnFilter').addEventListener('click', loadRiwayat);
            document.getElementById('btnPrev').addEventListener('click', prevPage);
            document.getElementById('btnNext').addEventListener('click', nextPage);
            
            // Invoice
            document.getElementById('btnCetakInvoice').addEventListener('click', function() {
                window.print();
            });
            
            // Book detail modal borrow button
            document.getElementById('btnBorrowFromDetail').addEventListener('click', function() {
                const book = {
                    judul: document.getElementById('detailJudul').textContent,
                    pengarang: document.getElementById('detailPengarang').textContent,
                    tahun: document.getElementById('detailTahun').textContent,
                    kategori: document.getElementById('detailKategori').textContent,
                    isbn: document.getElementById('detailISBN').textContent || 'ISBN-' + Math.random().toString(36).substr(2, 8).toUpperCase()
                };
                
                selectBookFromTable(book.judul, book.pengarang, book.tahun, book.kategori, book.isbn);
                bootstrap.Modal.getInstance(document.getElementById('bookDetailModal')).hide();
            });
        }

        function selectBookFromTable(judul, pengarang, tahun, kategori, isbn) {
            document.getElementById('bookId').value = 'book-' + Math.random().toString(36).substr(2, 9);
            document.getElementById('judulBuku').value = judul;
            document.getElementById('pengarang').value = pengarang;
            document.getElementById('tahunTerbit').value = tahun;
            document.getElementById('kategori').value = kategori;
            document.getElementById('isbn').value = isbn;
            
            showAlert('success', `Buku "${judul}" telah dipilih`);
        }

        function showBookDetail(judul, pengarang, tahun, kategori, isbn, deskripsi) {
            document.getElementById('detailJudul').textContent = judul;
            document.getElementById('detailPengarang').textContent = pengarang;
            document.getElementById('detailTahun').textContent = tahun;
            document.getElementById('detailKategori').textContent = kategori;
            document.getElementById('detailISBN').textContent = isbn;
            document.getElementById('detailDeskripsi').textContent = deskripsi || '-';
            
            const modal = new bootstrap.Modal(document.getElementById('bookDetailModal'));
            modal.show();
        }

        // ====================== VALIDATION FUNCTIONS ======================
        function validateReturnDate() {
            const returnDateInput = document.getElementById('modalTanggalKembali');
            const returnDate = new Date(returnDateInput.value);
            const borrowDate = new Date(currentInvoice.tanggal_pinjam);
            
            if (returnDate < borrowDate) {
                returnDateInput.setCustomValidity('Tanggal kembali tidak boleh lebih awal dari tanggal pinjam');
                showAlert('error', 'Tanggal kembali tidak valid: tidak boleh lebih awal dari tanggal pinjam');
            } else {
                returnDateInput.setCustomValidity('');
            }
            
            returnDateInput.reportValidity();
        }

        // ====================== LOAN FUNCTIONS ======================
        async function loadPeminjaman() {
            showLoading('Memuat data peminjaman...');
            try {
                const snapshot = await db.collection('peminjaman')
                    .where('tanggal_kembali', '==', null)
                    .orderBy('tanggal_pinjam', 'desc')
                    .get();

                peminjamanList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateTabelPengembalian();
            } catch (error) {
                console.error("Error loading loans:", error);
                showAlert('error', 'Gagal memuat data peminjaman: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function updateTabelPengembalian(filteredLoans = null) {
            const tbody = document.getElementById('pengembalianBody');
            tbody.innerHTML = '';

            const loansToShow = filteredLoans || peminjamanList;

            if (loansToShow.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <i class="fas fa-book-open fa-2x mb-3 text-muted"></i>
                            <p>Tidak ada peminjaman aktif</p>
                        </td>
                    </tr>
                `;
                return;
            }

            loansToShow.forEach((loan, index) => {
                const row = document.createElement('tr');
                row.className = 'animate__animated animate__fadeIn';
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${loan.judul_buku}</td>
                    <td>${loan.pengarang}</td>
                    <td>${loan.nama_peminjam}</td>
                    <td>${formatDate(loan.tanggal_pinjam)}</td>
                    <td>${formatDate(loan.jatuh_tempo)}</td>
                    <td><span class="status-borrowed">${loan.status}</span></td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="showPengembalianModal('${loan.id}')">
                            <i class="fas fa-undo me-1"></i>Proses
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function searchPeminjaman() {
            const searchTerm = document.getElementById('searchPeminjaman').value.toLowerCase();
            const filteredLoans = peminjamanList.filter(loan => 
                loan.judul_buku.toLowerCase().includes(searchTerm) ||
                loan.nama_peminjam.toLowerCase().includes(searchTerm)
            );
            updateTabelPengembalian(filteredLoans);
        }

        async function simpanPeminjaman() {
            const form = document.getElementById('formPeminjaman');
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                const invalidElements = form.querySelectorAll(':invalid');
                if (invalidElements.length > 0) {
                    invalidElements[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }

            const bookId = document.getElementById('bookId').value;
            if (!bookId) {
                showAlert('error', 'Harap pilih buku terlebih dahulu');
                return;
            }

            const book = {
                judul: document.getElementById('judulBuku').value,
                pengarang: document.getElementById('pengarang').value,
                tahun_terbit: document.getElementById('tahunTerbit').value,
                kategori: document.getElementById('kategori').value,
                isbn: document.getElementById('isbn').value
            };

            const loanData = {
                kode_buku: bookId,
                judul_buku: book.judul,
                pengarang: book.pengarang,
                nama_peminjam: document.getElementById('namaPeminjam').value.trim(),
                no_hp: document.getElementById('noHp').value.trim(),
                tanggal_pinjam: document.getElementById('tanggalPinjam').value,
                jatuh_tempo: hitungJatuhTempo(),
                lama_pinjam: document.getElementById('lamaPinjam').value,
                status: 'Dipinjam',
                catatan: document.getElementById('catatan').value.trim(),
                tanggal_kembali: null,
                hari_telat: 0,
                denda: 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            showLoading('Menyimpan peminjaman...');
            try {
                const docRef = await db.collection('peminjaman').add(loanData);
                
                showAlert('success', 'Peminjaman berhasil disimpan!');
                
                // Show invoice after successful submission
                setTimeout(() => {
                    showInvoice({ id: docRef.id, ...loanData });
                }, 500);
                
                resetForm();
                await loadPeminjaman();
            } catch (error) {
                console.error("Error saving loan:", error);
                showAlert('error', 'Gagal menyimpan peminjaman: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function hitungJatuhTempo() {
            try {
                const tglPinjam = document.getElementById('tanggalPinjam').value;
                const lamaPinjam = parseInt(document.getElementById('lamaPinjam').value);
                
                if (tglPinjam && lamaPinjam) {
                    const tglPinjamObj = new Date(tglPinjam);
                    const tglTempo = new Date(tglPinjamObj);
                    tglTempo.setDate(tglPinjamObj.getDate() + (lamaPinjam * 7));
                    
                    document.getElementById('jatuhTempo').value = formatDate(tglTempo.toISOString().split('T')[0]);
                    return tglTempo.toISOString().split('T')[0];
                }
                return null;
            } catch (error) {
                console.error("Error calculating due date:", error);
                return null;
            }
        }

        // ====================== RETURN FUNCTIONS ======================
        async function showPengembalianModal(loanId) {
            currentInvoice = peminjamanList.find(loan => loan.id === loanId);
            if (!currentInvoice) return;

            // Isi data modal
            document.getElementById('modalJudulBuku').value = currentInvoice.judul_buku;
            document.getElementById('modalPengarang').value = currentInvoice.pengarang;
            document.getElementById('modalNamaPeminjam').value = currentInvoice.nama_peminjam;
            document.getElementById('modalTanggalPinjam').value = formatDate(currentInvoice.tanggal_pinjam);
            document.getElementById('modalJatuhTempo').value = formatDate(currentInvoice.jatuh_tempo);
            document.getElementById('modalTanggalKembali').value = new Date().toISOString().split('T')[0];

            // Reset validation
            document.getElementById('modalTanggalKembali').setCustomValidity('');

            // Hitung denda awal
            previewDenda();
            pengembalianModal.show();
        }

        function previewDenda() {
            const returnDate = new Date(document.getElementById('modalTanggalKembali').value);
            const dueDate = new Date(currentInvoice.jatuh_tempo);
            const diffTime = returnDate - dueDate;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const hariTelat = diffDays > 0 ? diffDays : 0;
            const denda = hariTelat * DENDA_PER_HARI;

            document.getElementById('modalHariTelat').value = `${hariTelat} hari`;
            document.getElementById('modalDenda').value = formatRupiah(denda);
        }

        async function prosesPengembalian() {
            const returnDateInput = document.getElementById('modalTanggalKembali');
            if (!returnDateInput.value) {
                returnDateInput.setCustomValidity('Harap pilih tanggal kembali');
                returnDateInput.reportValidity();
                return;
            }

            showLoading('Memproses pengembalian...');
            try {
                const returnDate = returnDateInput.value;
                const dueDate = new Date(currentInvoice.jatuh_tempo);
                const diffDays = Math.ceil((new Date(returnDate) - dueDate) / (1000 * 60 * 60 * 24));
                
                const updateData = {
                    tanggal_kembali: returnDate,
                    hari_telat: diffDays > 0 ? diffDays : 0,
                    denda: diffDays > 0 ? diffDays * DENDA_PER_HARI : 0,
                    status: diffDays > 0 ? 'Terlambat' : 'Dikembalikan'
                };

                await db.collection('peminjaman').doc(currentInvoice.id).update(updateData);

                pengembalianModal.hide();
                
                // Show invoice if there's a late fee
                if (updateData.denda > 0) {
                    setTimeout(() => {
                        showInvoice({ ...currentInvoice, ...updateData }, true);
                    }, 500);
                } else {
                    showAlert('success', 'Pengembalian berhasil diproses!');
                }
                
                await loadPeminjaman();
                await loadRiwayat();
            } catch (error) {
                console.error("Error processing return:", error);
                showAlert('error', 'Gagal memproses pengembalian: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // ====================== INVOICE FUNCTIONS ======================
        function showInvoice(loanData, isLateReturn = false) {
            // Generate invoice number (INV-YYYYMM-XXXX)
            const now = new Date();
            const invoiceNumber = `INV-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}-${String(loanData.id).substr(0, 4)}`;
            
            // Fill in invoice data
            document.getElementById('invoiceNumber').textContent = invoiceNumber;
            document.getElementById('invoiceNamaPeminjam').textContent = loanData.nama_peminjam || '-';
            document.getElementById('invoiceNoHp').textContent = loanData.no_hp || '-';
            document.getElementById('invoiceTanggalPinjam').textContent = formatDate(loanData.tanggal_pinjam);
            document.getElementById('invoiceJatuhTempo').textContent = formatDate(loanData.jatuh_tempo);
            
            // Fill book details
            const bookDetails = document.getElementById('invoiceBookDetails');
            bookDetails.innerHTML = `
                <tr>
                    <td>${loanData.judul_buku || '-'}</td>
                    <td>${loanData.pengarang || '-'}</td>
                    <td>${loanData.lama_pinjam ? loanData.lama_pinjam + ' minggu' : '-'}</td>
                    <td>
                        <span class="badge ${loanData.status === 'Terlambat' ? 'bg-danger' : 'bg-success'}">
                            ${loanData.status || 'Dipinjam'}
                        </span>
                    </td>
                </tr>
            `;
            
            // Handle late return section
            const dendaSection = document.getElementById('dendaSection');
            if (isLateReturn && loanData.denda > 0) {
                dendaSection.classList.remove('d-none');
                document.getElementById('invoiceTanggalKembali').textContent = formatDate(loanData.tanggal_kembali);
                document.getElementById('invoiceHariTelat').textContent = loanData.hari_telat || 0;
                document.getElementById('invoiceDenda').textContent = formatRupiah(loanData.denda);
            } else {
                dendaSection.classList.add('d-none');
            }
            
            // Initialize and show modal
            invoiceModal.show();
            
            // Set up print button
            document.getElementById('btnCetakInvoice').onclick = function() {
                // Clone the modal content
                const printContent = document.getElementById('invoiceModal').cloneNode(true);
                
                // Remove elements with no-print class
                const noPrintElements = printContent.querySelectorAll('.no-print');
                noPrintElements.forEach(el => el.remove());
                
                // Create print window
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Cetak Invoice Peminjaman Buku</title>
                        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                        <style>
                            body {
                                padding: 20px;
                                font-size: 14px;
                            }
                            .table {
                                font-size: 13px;
                            }
                            .table th {
                                background-color: #f8f9fa !important;
                            }
                            .badge {
                                font-size: 12px;
                            }
                            .signature-box {
                                height: 80px;
                                margin-top: 40px;
                                position: relative;
                            }
                            .signature-line {
                                position: absolute;
                                bottom: 0;
                                width: 100%;
                                border-top: 1px solid #000;
                            }
                            @page {
                                size: A4;
                                margin: 10mm;
                            }
                            @media print {
                                body {
                                    padding: 0;
                                    font-size: 12px;
                                }
                                .table {
                                    font-size: 11px;
                                }
                                .modal-header {
                                    background-color: #4361ee !important;
                                    color: white !important;
                                    -webkit-print-color-adjust: exact;
                                    print-color-adjust: exact;
                                }
                            }
                        </style>
                    </head>
                    <body onload="window.print();">
                        ${printContent.querySelector('.modal-content').outerHTML}
                    </body>
                    </html>
                `);
                printWindow.document.close();
            };
        }

        // ====================== HISTORY FUNCTIONS ======================
        async function loadRiwayat() {
            showLoading('Memuat riwayat...');
            try {
                let query = db.collection('peminjaman')
                    .orderBy('tanggal_pinjam', 'desc');

                // Filter tanggal
                const dari = document.getElementById('filterDari').value;
                const sampai = document.getElementById('filterSampai').value;
                if (dari && sampai) {
                    query = query.where('tanggal_pinjam', '>=', dari)
                                .where('tanggal_pinjam', '<=', sampai);
                }

                // Pencarian
                const searchTerm = document.getElementById('searchRiwayat').value.toLowerCase();
                if (searchTerm) {
                    // Firestore doesn't support OR queries directly, so we'll filter client-side
                    const snapshot = await query.get();
                    riwayatList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(loan => 
                            loan.nama_peminjam.toLowerCase().includes(searchTerm) ||
                            loan.judul_buku.toLowerCase().includes(searchTerm)
                        );
                } else {
                    const snapshot = await query.get();
                    riwayatList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }

                document.getElementById('totalData').textContent = riwayatList.length;
                updateRiwayatTable();
                updatePagination();
            } catch (error) {
                console.error("Error loading history:", error);
                showAlert('error', 'Gagal memuat riwayat: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function updateRiwayatTable() {
            const tbody = document.getElementById('riwayatBody');
            tbody.innerHTML = '';

            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const currentData = riwayatList.slice(start, end);

            if (currentData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center py-4">
                            <i class="fas fa-book-open fa-2x mb-3 text-muted"></i>
                            <p>Tidak ada data riwayat</p>
                        </td>
                    </tr>
                `;
                return;
            }

            currentData.forEach((loan, index) => {
                const row = document.createElement('tr');
                row.className = 'animate__animated animate__fadeIn';
                row.innerHTML = `
                    <td>${start + index + 1}</td>
                    <td>${loan.judul_buku}</td>
                    <td>${loan.pengarang}</td>
                    <td>${loan.nama_peminjam}</td>
                    <td>${formatDate(loan.tanggal_pinjam)}</td>
                    <td>${formatDate(loan.jatuh_tempo)}</td>
                    <td>${loan.tanggal_kembali ? formatDate(loan.tanggal_kembali) : '-'}</td>
                    <td>${loan.hari_telat || '-'} hari</td>
                    <td>${loan.denda ? formatRupiah(loan.denda) : '-'}</td>
                    <td><span class="${loan.status === 'Terlambat' ? 'status-late' : 'status-returned'}">${loan.status}</span></td>
                `;
                tbody.appendChild(row);
            });

            // Hitung total denda
            const totalDenda = riwayatList.reduce((sum, loan) => sum + (loan.denda || 0), 0);
            document.getElementById('totalDenda').textContent = formatRupiah(totalDenda);
        }

        function searchRiwayat() {
            const searchTerm = document.getElementById('searchRiwayat').value.toLowerCase();
            const filteredRiwayat = riwayatList.filter(loan => 
                loan.judul_buku.toLowerCase().includes(searchTerm) ||
                loan.nama_peminjam.toLowerCase().includes(searchTerm)
            );
            updateRiwayatTable(filteredRiwayat);
        }

        function updatePagination() {
            const btnPrev = document.getElementById('btnPrev');
            const btnNext = document.getElementById('btnNext');
            btnPrev.disabled = currentPage === 1;
            btnNext.disabled = currentPage * ITEMS_PER_PAGE >= riwayatList.length;
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                updateRiwayatTable();
                updatePagination();
            }
        }

        function nextPage() {
            if (currentPage * ITEMS_PER_PAGE < riwayatList.length) {
                currentPage++;
                updateRiwayatTable();
                updatePagination();
            }
        }

        // ====================== HELPER FUNCTIONS ======================
        function formatDate(dateString) {
            if (!dateString) return '-';
            const options = { day: '2-digit', month: 'long', year: 'numeric' };
            return new Date(dateString).toLocaleDateString('id-ID', options);
        }

        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount || 0);
        }

        function getFirstDayOfMonth() {
            const date = new Date();
            return new Date(date.getFullYear(), date.getMonth(), 1).toISOString().split('T')[0];
        }

        function debounce(func, timeout = 300) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => func.apply(this, args), timeout);
            };
        }

        function resetForm() {
            document.getElementById('formPeminjaman').reset();
            document.getElementById('formPeminjaman').classList.remove('was-validated');
            document.getElementById('bookId').value = '';
            document.getElementById('jatuhTempo').value = '';
            document.getElementById('charCount').textContent = '0/200';
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggalPinjam').value = today;
        }

        function showLoading(message = 'Memproses...') {
            document.getElementById('loadingText').textContent = message;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showAlert(type, message) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} animate__animated animate__fadeInRight`;
            alert.role = 'alert';
            alert.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'times-circle' : type === 'info' ? 'info-circle' : 'check-circle'} me-2"></i>
                ${message}
            `;
            document.getElementById('alertContainer').appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        // Make functions available globally for HTML event handlers
        window.selectBookFromTable = selectBookFromTable;
        window.showPengembalianModal = showPengembalianModal;
        window.showBookDetail = showBookDetail;
    </script>
</body>
</html>